# KUKA Vision Correction System Configuration

This document describes the configuration system for the KUKA vision correction system.

## Overview

The system now uses JSON configuration files instead of hardcoded values. This provides:
- Easy configuration changes without code modification
- Environment-specific configurations (development, production, etc.)
- Separation of concerns between code and configuration
- Better maintainability and deployment flexibility

## Configuration Files

### 1. System Configuration (`system_config.json`)

The main system configuration file contains all operational parameters:

```json
{
  "camera": {
    "index": 0,           // Camera device index
    "resolution": [1920, 1080],  // Camera resolution [width, height]
    "fps": 30             // Camera frame rate
  },
  "robot": {
    "model": "KR250_R2700-2"    // Robot model identifier
  },
  "communication": {
    "controller_ip": "127.0.0.1",  // Controller helper IP
    "controller_port": 7001,       // Controller helper port
    "timeout": 1.0                 // Communication timeout (seconds)
  },
  "vision_correction": {
    "position_threshold": 0.5,     // Position threshold (mm)
    "rotation_threshold": 0.5,     // Rotation threshold (degrees) 
    "confidence_threshold": 0.7,   // Minimum detection confidence [0-1]
    "max_correction": 3.0          // Maximum correction magnitude (mm)
  },
  "board_matching": {
    "max_position_error": 30.0,    // Max board position error (mm)
    "max_rotation_error": 15.0,    // Max board rotation error (degrees)
    "position_weight": 1.0,        // Position weight in matching
    "rotation_weight": 0.2         // Rotation weight in matching
  },
  "processing": {
    "rate": 30.0,                  // Processing rate (Hz)
    "buffer_size": 200,            // Sample buffer size
    "max_time_skew": 0.5           // Max time skew allowance (seconds)
  },
  "files": {
  "charuco_boards_config": "charuco_boards_config.json",  // ChArUco boards config
    "camera_calibration": "camera_calibration.npz",     // Camera calibration
    "robot_config": "robot_config.json"                 // Robot configuration
  }
}
```

### 2. ChArUco Boards Configuration (`charuco_boards_config.json`)

Defines the ChArUco boards used in the system:

```json
{
  "boards": [
    {
      "board_id": "station_1_board",
      "squares_x": 7,                    // Number of squares horizontally
      "squares_y": 5,                    // Number of squares vertically  
      "square_size": 0.04,               // Square size in meters
      "marker_size": 0.03,               // Marker size in meters
      "dictionary_type": 10,             // ArUco dictionary (DICT_6X6_250)
      "expected_plane": [450.0, 200.0, 10.0, 0.0, 0.0, 0.0]  // [x,y,z,rx,ry,rz]
    }
    // Additional boards...
  ]
}
```

### 3. Camera Calibration (`camera_calibration.npz`)

Contains camera intrinsic parameters (generated by calibration script):
- `camera_matrix`: 3x3 camera intrinsic matrix
- `distortion_coeffs`: Camera distortion coefficients
- `calibration_error`: RMS reprojection error

### 4. Robot Configuration (`robot_config.json`)

Robot-specific parameters and coordinate transformations.

## Usage

### Starting the System

```bash
# Basic usage with default configuration
./start_tracking.py

# Specify custom configuration file
./start_tracking.py --config my_config.json

# Enable verbose logging
./start_tracking.py --verbose

# Validate configuration only (don't start system)
./start_tracking.py --validate-only
```

### Configuration Validation

The system validates all configuration files before starting:
- Checks that all required files exist
- Validates JSON syntax
- Verifies parameter ranges and types

### Environment-Specific Configurations

Create different configuration files for different environments:

```bash
# Development environment
./start_tracking.py --config configs/development.json

# Production environment  
./start_tracking.py --config configs/production.json

# Testing environment
./start_tracking.py --config configs/testing.json
```

## Migration from Old System

The old `example_production_charuco.py` file contained hardcoded configuration. This has been replaced with:

1. **System Configuration**: `system_config.json` - Contains all system parameters
2. **Board Configuration**: `charuco_boards_config.json` - Contains ChArUco board definitions
3. **Startup Script**: `start_tracking.py` - Clean startup without hardcoded values

### Benefits of New System

- **Flexibility**: Easy to create different configurations for different setups
- **Maintainability**: No code changes needed for configuration updates
- **Validation**: Built-in configuration validation prevents startup with invalid configs
- **Documentation**: Self-documenting configuration files with clear parameter names
- **Version Control**: Configuration files can be versioned separately from code

## Configuration Parameters Reference

### Camera Settings
- `index`: Camera device index (usually 0 for first camera)
- `resolution`: Camera resolution as [width, height] in pixels
- `fps`: Camera frame rate in frames per second

### Vision Correction Settings
- `position_threshold`: Minimum position error to trigger correction (mm)
- `rotation_threshold`: Minimum rotation error to trigger correction (degrees)
- `confidence_threshold`: Minimum detection confidence required [0.0-1.0]
- `max_correction`: Maximum correction magnitude allowed (mm)

### Board Matching Settings
- `max_position_error`: Maximum allowed position error for board matching (mm)
- `max_rotation_error`: Maximum allowed rotation error for board matching (degrees)
- `position_weight`: Relative weight of position in matching algorithm
- `rotation_weight`: Relative weight of rotation in matching algorithm

### Processing Settings
- `rate`: Main processing loop rate (Hz)
- `buffer_size`: Number of samples to keep in circular buffers
- `max_time_skew`: Maximum allowable time difference between camera and controller data (seconds)

## Troubleshooting

### Configuration File Not Found
Ensure the configuration file path is correct and the file exists.

### Invalid JSON
Use a JSON validator to check syntax. Common issues:
- Missing commas between array/object elements
- Trailing commas (not allowed in JSON)
- Unquoted keys or strings

### Missing Required Files
The system validates that all referenced files exist. Check file paths in the `files` section of the configuration.
