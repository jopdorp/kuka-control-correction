#!/bin/bash
# KUKA Hotspot Control Script
# Generated by Ansible

INTERFACE="{{ hotspot_interface }}"
HOTSPOT_IP="{{ hotspot_ip }}"

case "$1" in
    start)
        echo "🚀 Starting KUKA WiFi Hotspot..."
        systemctl start hostapd
        systemctl start dnsmasq
        
        # Wait a moment for services to start
        sleep 2
        
        if systemctl is-active --quiet hostapd && systemctl is-active --quiet dnsmasq; then
            echo "✅ Hotspot started successfully!"
            echo
            echo "📡 Connection Details:"
            echo "   SSID: {{ hotspot_ssid }}"
            echo "   Password: {{ hotspot_password }}"
            echo "   Pi IP: {{ hotspot_ip }}"
            echo "   Upload Service: http://kuka.drop:8000 or http://{{ hotspot_ip }}:8000"
        else
            echo "❌ Failed to start hotspot services"
            echo "Check status with: systemctl status hostapd dnsmasq"
            exit 1
        fi
        ;;
    
    stop)
        echo "🛑 Stopping KUKA WiFi Hotspot..."
        systemctl stop hostapd
        systemctl stop dnsmasq
        echo "✅ Hotspot stopped"
        ;;
    
    restart)
        echo "🔄 Restarting KUKA WiFi Hotspot..."
        $0 stop
        sleep 2
        $0 start
        ;;
    
    status)
        echo "📊 KUKA Hotspot Status:"
        echo "   Hostapd: $(systemctl is-active hostapd)"
        echo "   Dnsmasq: $(systemctl is-active dnsmasq)"
        echo "   Interface: $(ip addr show $INTERFACE | grep 'state UP' >/dev/null && echo 'UP' || echo 'DOWN')"
        
        if systemctl is-active --quiet hostapd; then
            echo
            echo "📱 Network Info:"
            echo "   SSID: {{ hotspot_ssid }}"
            echo "   IP: $HOTSPOT_IP"
            
            # Show connected clients if possible
            if command -v iw >/dev/null 2>&1; then
                CLIENTS=$(iw dev $INTERFACE station dump | grep Station | wc -l)
                echo "   Connected clients: $CLIENTS"
            fi
        fi
        ;;
    
    enable)
        echo "🔧 Enabling KUKA Hotspot to start on boot..."
        systemctl enable kuka-hotspot
        echo "✅ Hotspot will start automatically on boot"
        ;;
    
    disable)
        echo "🔧 Disabling KUKA Hotspot auto-start..."
        systemctl disable kuka-hotspot
        $0 stop
        echo "✅ Hotspot auto-start disabled"
        ;;
    
    *)
        echo "KUKA WiFi Hotspot Control"
        echo "========================"
        echo "Usage: $0 {start|stop|restart|status|enable|disable}"
        echo
        echo "Commands:"
        echo "  start    - Start the WiFi hotspot"
        echo "  stop     - Stop the WiFi hotspot"
        echo "  restart  - Restart the WiFi hotspot"
        echo "  status   - Show hotspot status and info"
        echo "  enable   - Enable auto-start on boot"
        echo "  disable  - Disable auto-start on boot"
        echo
        echo "After starting, connect to:"
        echo "  SSID: {{ hotspot_ssid }}"
        echo "  Password: {{ hotspot_password }}"
        echo "  Access upload service: http://kuka.drop:8000 or http://{{ hotspot_ip }}:8000"
        exit 1
        ;;
esac
